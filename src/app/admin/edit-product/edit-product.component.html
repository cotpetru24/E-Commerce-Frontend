<div class="container mt-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a routerLink="/admin" class="text-decoration-none">
          <i class="bi bi-house me-1"></i>Admin Dashboard
        </a>
      </li>
      <li class="breadcrumb-item">
        <a routerLink="/admin/products" class="text-decoration-none">
          <i class="bi bi-box me-1"></i>Product Management
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <i class="bi bi-pencil-square me-1"></i>Edit Product
      </li>
    </ol>
  </nav>

  <div class="row justify-content-center mb-4">
    <div class="col-lg-10">
      <div class="card shadow">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">
            <i class="bi bi-pencil-square me-2"></i>
            Edit Product
          </h4>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info" *ngIf="!productData">
            <i class="bi bi-info-circle me-2"></i>
            Loading product data...
          </div>

          <form (ngSubmit)="onSubmit()" #editProductForm="ngForm" *ngIf="productData">
            <div class="row">
              <div class="col-md-8">
                <!-- Basic Information -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">
                      <i class="bi bi-tag me-2"></i>Product Name *
                    </label>
                    <input type="text" class="form-control" id="name" name="name" [(ngModel)]="productData.name"
                      required placeholder="Enter product name"
                      [ngClass]="{'is-invalid': editProductForm.submitted && !productData.name}">
                    <div class="invalid-feedback" *ngIf="editProductForm.submitted && !productData.name">
                      Product name is required.
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="brand" class="form-label">
                      <i class="bi bi-award me-2"></i>Brand
                    </label>
                    <select class="form-select" id="brand" name="brand" [(ngModel)]="productData.brandId">
                      <option value="" disabled>Select brand</option>
                      <option *ngFor="let b of brands" [ngValue]="b.brandId">
                        {{ b.brandName| titlecase }}
                      </option>
                    </select>



                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="price" class="form-label">
                      <i class="bi bi-currency-pound me-2"></i>Price *
                    </label>
                    <div class="input-group">
                      <span class="input-group-text">Â£</span>
                      <input type="text" class="form-control" name="price" [(ngModel)]="priceText"
                        inputmode="decimal" pattern="^[0-9]*\.?[0-9]*$" (keypress)="allowDecimalOnly($event)"
                        (blur)="normalizePrice()" placeholder="0.00"
                        [ngClass]="{'is-invalid': editProductForm.submitted && !productData.price}" />
                      </div>
                    <div class="invalid-feedback" *ngIf="editProductForm.submitted && !productData.price">
                      Price is required.
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="priceDiscount" class="form-label">
                      <i class="bi bi-percent me-2"></i>Discount *
                    </label>
                    <div class="input-group">
                      <span class="input-group-text">%</span>
                      <input type="text" class="form-control" name="priceDiscount" [(ngModel)]="discountText"
                        inputmode="decimal" pattern="^[0-9]*\.?[0-9]*$" (keypress)="allowDecimalOnly($event)"
                        (blur)="normalizeDiscount()" placeholder="0.00"
                        [ngClass]="{'is-invalid': editProductForm.submitted && !productData.discountPercentage}" />
                    </div>
                    <div class="invalid-feedback" *ngIf="editProductForm.submitted && !productData.discountPercentage">
                      Price is required.
                    </div>
                  </div>


                </div>

                <div class="row">

                  <div class="col-md-6 mb-3">
                    <label for="stock" class="form-label">
                      <i class="bi bi-box-seam me-2"></i>Stock Quantity *
                    </label>
                    <input type="number" class="form-control" id="stock" name="stock" [(ngModel)]="productData.stock"
                      required min="0" placeholder="0"
                      [ngClass]="{'is-invalid': editProductForm.submitted && (productData.stock === null || productData.stock === undefined)}">
                    <div class="invalid-feedback"
                      *ngIf="editProductForm.submitted && (productData.stock === null || productData.stock === undefined)">
                      Stock quantity is required.
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="audienceOptions" class="form-label">
                      <i class="bi bi-gender-ambiguous me-2"></i>Gender
                    </label>
                    <select class="form-select" id="audienceOptions" name="audienceOptions" [(ngModel)]="productData.audienceId">
                      <option value="" disabled>Select Gender</option>
                      <option *ngFor="let a of productAudience" [value]="a.audienceId">
                        {{ a.audienceName| titlecase }}
                      </option>
                    </select>




                  </div>


                </div>

                <div class="mb-3">
                  <label for="description" class="form-label">
                    <i class="bi bi-card-text me-2"></i>Description *
                  </label>
                  <textarea class="form-control" id="description" name="description"
                    [(ngModel)]="productData.description" required rows="4" placeholder="Enter product description"
                    [ngClass]="{'is-invalid': editProductForm.submitted && !productData.description}"></textarea>
                  <div class="invalid-feedback" *ngIf="editProductForm.submitted && !productData.description">
                    Description is required.
                  </div>
                </div>

                <!-- Features -->
                <div class="mb-3">
                  <label class=" col-md-3 form-label">
                    <i class="bi bi-list-check me-2"></i>Feature order
                  </label>
                  <label class=" col-md-7 form-label">
                    <i class="bi bi-list-check me-2"></i>Feature text
                  </label>
                  <div class="row">

                    @for (feature of productData.productFeatures; track $index) {


                    <div class="col-md-3 mb-2">
                      <input type="number" class="form-control" placeholder="Feature order..."
                        [(ngModel)]="feature.sortOrder" name="sortOrder{{$index}}">
                    </div>

                    <div class="col-md-7 mb-2">
                      <input type="text" class="form-control" placeholder="Feature text..."
                        [(ngModel)]="feature.featureText" name="featureText{{$index}}">
                    </div>

                    <div class="col-md-2 mb-2">
                      <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeSpecification($index)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    }



                    <div class="col-md-3 mb-2">
                      <input type="text" class="form-control" placeholder="Feature order..."
                        [(ngModel)]="newSpec.sortOrder" name="specName">
                    </div>
                    <div class="col-md-7 mb-2">
                      <input type="text" class="form-control" placeholder="Feature text..."
                        [(ngModel)]="newSpec.featureText" name="specValue">
                    </div>
                    <div class="col-md-2 mb-2">
                      <button type="button" class="btn btn-outline-primary btn-sm" (click)="addSpecification()">
                        <i class="bi bi-plus"></i>
                      </button>

                    </div>
                  </div>

                </div>
              </div>

              <div class="col-md-4">

                <!-- Status -->
                <div class="mb-3">
                  <label class="form-label">
                    <i class="bi bi-toggle-on me-2"></i>Status
                  </label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isActive" [(ngModel)]="productData.isActive"
                      name="isActive">
                    <label class="form-check-label" for="isActive">
                      Active (Available for purchase)
                    </label>
                  </div>
                </div>

                <!-- Product Stats -->
                <div class="card bg-light mb-3">
                  <div class="card-body">
                    <h6 class="card-title">
                      <i class="bi bi-graph-up me-2"></i>Product Stats
                    </h6>
                    <div class="row text-center">
                      <div class="col-6">
                        <div class="h4 text-primary">{{productData.reviewCount || 0}}</div>
                        <small class="text-muted">Reviews</small>
                      </div>
                      <div class="col-6">
                        <div class="h4 text-success">{{productData.rating || 0}}/5</div>
                        <small class="text-muted">Rating</small>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="mb-3">
                  <div class="row">
                    <div class="col-12 mb-2">
                      <div class="fw-semibold">Date created</div>
                      <div class="text-muted small">
                        {{ productData.createdAt | date:'medium' }}
                      </div>
                    </div>

                    <div class="col-12">
                      <div class="fw-semibold">Last updated</div>
                      <div class="text-muted small">
                        {{ productData.updatedAt | date:'medium' }}
                      </div>
                    </div>
                  </div>
                </div>


              </div>
            </div>
            
            <hr class="my-4">

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" routerLink="/admin/products">
                <i class="bi bi-arrow-left me-2"></i>Back
              </button>
              <div>
                <button type="button" class="btn btn-outline-danger me-2" (click)="deleteProduct()"
                  [disabled]="isLoading">
                  <i class="bi bi-trash me-2"></i>Delete Product
                </button>
                <button type="submit" class="btn btn-warning" [disabled]="isLoading">
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  <i class="bi bi-check-circle me-2" *ngIf="!isLoading"></i>
                  {{ isLoading ? 'Updating Product...' : 'Update Product' }}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>